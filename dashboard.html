{% extends "base.html" %}
{% block title %}Dashboard - CHD App{% endblock %}
{% block content %}
<div class="dashboard-container">
  <!-- Dashboard Header -->
  <div class="dashboard-header card">
    <div class="welcome-section">
      <div class="welcome-icon">üëã</div>
      <div class="welcome-text">
        <h1>Welcome back!</h1>
        <p>{{ session.get('email', 'User') }}</p>
      </div>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('predict_page') }}" class="btn-primary">
        <span class="btn-icon">‚ûï</span>
        New Assessment
      </a>
      <button id="logout-btn" class="btn-secondary">
        <span class="btn-icon">üö™</span>
        Logout
      </button>
    </div>
  </div>

  <!-- Dashboard Stats -->
  <div class="stats-grid">
    <div class="stat-card card">
      <div class="stat-icon">üìä</div>
      <div class="stat-content">
        <div class="stat-number" id="total-assessments">-</div>
        <div class="stat-label">Total Assessments</div>
      </div>
    </div>
    
    <div class="stat-card card">
      <div class="stat-icon risk-low">‚úÖ</div>
      <div class="stat-content">
        <div class="stat-number" id="low-risk-count">-</div>
        <div class="stat-label">Low Risk</div>
      </div>
    </div>
    
    <div class="stat-card card">
      <div class="stat-icon risk-moderate">‚ö†Ô∏è</div>
      <div class="stat-content">
        <div class="stat-number" id="moderate-risk-count">-</div>
        <div class="stat-label">Moderate Risk</div>
      </div>
    </div>
    
    <div class="stat-card card">
      <div class="stat-icon risk-high">üö®</div>
      <div class="stat-content">
        <div class="stat-number" id="high-risk-count">-</div>
        <div class="stat-label">High Risk</div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions card">
    <h3>Quick Actions</h3>
    <div class="action-grid">
      <a href="{{ url_for('predict_page') }}" class="action-item">
        <div class="action-icon">üî¨</div>
        <div class="action-content">
          <strong>New Risk Assessment</strong>
          <p>Evaluate CHD risk with current health data</p>
        </div>
      </a>
      
      <div class="action-item" onclick="exportHistory()">
        <div class="action-icon">üìÑ</div>
        <div class="action-content">
          <strong>Export History</strong>
          <p>Download your assessment history</p>
        </div>
      </div>
      
      <div class="action-item" onclick="showHealthTips()">
        <div class="action-icon">üí°</div>
        <div class="action-content">
          <strong>Health Tips</strong>
          <p>Get personalized recommendations</p>
        </div>
      </div>
      
      <div class="action-item" onclick="scheduleReminder()">
        <div class="action-icon">‚è∞</div>
        <div class="action-content">
          <strong>Schedule Reminder</strong>
          <p>Set up regular check-in notifications</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Prediction History -->
  <div class="history-section card">
    <div class="section-header">
      <h3>üìã Assessment History</h3>
      <div class="header-controls">
        <select id="risk-filter" class="filter-select">
          <option value="">All Risk Levels</option>
          <option value="Low">Low Risk</option>
          <option value="Moderate">Moderate Risk</option>
          <option value="High">High Risk</option>
        </select>
        <button id="refresh-history" class="btn-refresh">
          <span class="btn-icon">üîÑ</span>
          Refresh
        </button>
      </div>
    </div>

    <div class="table-container">
      <table class="history-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Risk Level</th>
            <th>Probability</th>
            <th>Key Factors</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="history-body">
          <tr class="loading-row">
            <td colspan="5">
              <div class="loading-state">
                <span class="loading-spinner"></span>
                Loading your assessment history...
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="table-footer">
      <div class="pagination" id="pagination-controls">
        <!-- Pagination will be added dynamically -->
      </div>
      <div class="table-info">
        Showing <span id="showing-count">0</span> of <span id="total-count">0</span> assessments
      </div>
    </div>
  </div>

  <!-- Health Tips Modal -->
  <div id="health-tips-modal" class="modal">
    <div class="modal-content card">
      <div class="modal-header">
        <h3>üí° Personalized Health Tips</h3>
        <button class="modal-close" onclick="closeModal('health-tips-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="health-tips-content">
          <div class="loading-state">
            <span class="loading-spinner"></span>
            Generating personalized recommendations...
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.dashboard-container {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.welcome-section {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.welcome-icon {
  font-size: 3rem;
}

.welcome-text h1 {
  color: #6B052F;
  margin: 0 0 0.25rem 0;
  font-size: 1.8rem;
}

.welcome-text p {
  color: #A93E53;
  margin: 0;
  font-size: 1rem;
  font-weight: 500;
}

.header-actions {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.btn-primary, .btn-secondary {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.3s ease;
  font-size: 1rem;
}

.btn-primary {
  background: linear-gradient(135deg, #A93E53, #6B052F);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(169, 62, 83, 0.3);
}

.btn-secondary {
  background: rgba(169, 62, 83, 0.1);
  color: #6B052F;
  border: 1px solid rgba(169, 62, 83, 0.2);
}

.btn-secondary:hover {
  background: rgba(169, 62, 83, 0.2);
  transform: translateY(-1px);
}

.btn-refresh {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: rgba(169, 62, 83, 0.1);
  color: #6B052F;
  border: 1px solid rgba(169, 62, 83, 0.2);
  border-radius: 6px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-refresh:hover {
  background: rgba(169, 62, 83, 0.2);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  background: rgba(255, 255, 255, 0.95);
  transition: transform 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-5px);
}

.stat-icon {
  font-size: 2.5rem;
  flex-shrink: 0;
}

.stat-content {
  flex: 1;
}

.stat-number {
  font-size: 2rem;
  font-weight: 700;
  color: #6B052F;
  line-height: 1;
  margin-bottom: 0.25rem;
}

.stat-label {
  color: #A93E53;
  font-size: 0.9rem;
  font-weight: 600;
}

.quick-actions h3 {
  color: #6B052F;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1rem;
}

.action-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(169, 62, 83, 0.1);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  color: inherit;
}

.action-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(169, 62, 83, 0.1);
  background: rgba(255, 255, 255, 0.9);
}

.action-icon {
  font-size: 2rem;
  flex-shrink: 0;
}

.action-content strong {
  color: #6B052F;
  display: block;
  margin-bottom: 0.25rem;
  font-size: 1.05rem;
}

.action-content p {
  color: #666;
  margin: 0;
  font-size: 0.9rem;
  line-height: 1.3;
}

.history-section {
  min-height: 400px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.section-header h3 {
  color: #6B052F;
  margin: 0;
  font-size: 1.4rem;
}

.header-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.filter-select {
  padding: 0.5rem 1rem;
  border: 1px solid rgba(169, 62, 83, 0.2);
  border-radius: 6px;
  background: white;
  color: #6B052F;
  font-size: 0.9rem;
  cursor: pointer;
}

.table-container {
  overflow-x: auto;
  border-radius: 12px;
  border: 1px solid rgba(169, 62, 83, 0.1);
}

.history-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  margin: 0;
  box-shadow: none;
}

.history-table th {
  background: linear-gradient(135deg, #A93E53, #6B052F);
  color: white;
  padding: 1rem;
  text-align: left;
  font-weight: 600;
  font-size: 0.95rem;
}

.history-table td {
  padding: 1rem;
  border-bottom: 1px solid rgba(169, 62, 83, 0.05);
  vertical-align: middle;
}

.history-table tr:hover {
  background: rgba(255, 220, 209, 0.1);
}

.risk-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

.risk-low {
  background: rgba(40, 167, 69, 0.1);
  color: #185033;
  border: 1px solid rgba(40, 167, 69, 0.2);
}

.risk-moderate {
  background: rgba(255, 193, 7, 0.1);
  color: #6b4b1f;
  border: 1px solid rgba(255, 193, 7, 0.2);
}

.risk-high {
  background: rgba(220, 53, 69, 0.1);
  color: #7a1b1b;
  border: 1px solid rgba(220, 53, 69, 0.2);
}

.probability-text {
  font-weight: 600;
  font-size: 1.05rem;
}

.key-factors {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
}

.factor-tag {
  background: rgba(169, 62, 83, 0.1);
  color: #6B052F;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 500;
}

.action-buttons {
  display: flex;
  gap: 0.5rem;
}

.btn-small {
  padding: 0.5rem 0.75rem;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

.btn-view {
  background: rgba(169, 62, 83, 0.1);
  color: #6B052F;
}

.btn-view:hover {
  background: rgba(169, 62, 83, 0.2);
}

.loading-row {
  height: 200px;
}

.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  padding: 2rem;
  color: #A93E53;
}

.loading-spinner {
  display: inline-block;
  width: 30px;
  height: 30px;
  border: 3px solid rgba(169, 62, 83, 0.1);
  border-top: 3px solid #A93E53;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.table-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 1rem;
  padding: 1rem 0;
  border-top: 1px solid rgba(169, 62, 83, 0.1);
}

.table-info {
  color: #666;
  font-size: 0.9rem;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: #A93E53;
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  display: block;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
}

.modal-content {
  position: relative;
  margin: 5% auto;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(169, 62, 83, 0.1);
}

.modal-header h3 {
  color: #6B052F;
  margin: 0;
}

.modal-close {
  background: none;
  border: none;
  font-size: 2rem;
  cursor: pointer;
  color: #A93E53;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close:hover {
  background: rgba(169, 62, 83, 0.1);
  border-radius: 50%;
}

/* Responsive Design */
@media (max-width: 1024px) {
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
  
  .action-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .dashboard-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .header-actions {
    width: 100%;
  }
  
  .btn-primary, .btn-secondary {
    flex: 1;
    justify-content: center;
  }
  
  .section-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .header-controls {
    width: 100%;
  }
  
  .table-footer {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }
  
  .history-table th,
  .history-table td {
    padding: 0.75rem 0.5rem;
    font-size: 0.9rem;
  }
  
  .key-factors {
    flex-direction: column;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .stat-card {
    flex-direction: column;
    text-align: center;
  }
  
  .modal-content {
    margin: 2% auto;
    max-width: 95%;
  }
}
</style>

<script>
// Dashboard functionality
let currentPage = 1;
let allPredictions = [];
let filteredPredictions = [];

async function loadDashboardData() {
  try {
    const res = await fetch('/history', { credentials: 'same-origin' });
    
    if (!res.ok) {
      showError('Failed to load dashboard data');
      return;
    }
    
    const data = await res.json();
    allPredictions = data.predictions || [];
    filteredPredictions = [...allPredictions];
    
    updateStats();
    renderHistory();
    
  } catch (error) {
    console.error('Error loading dashboard:', error);
    showError('Network error loading dashboard data');
  }
}

function updateStats() {
  const total = allPredictions.length;
  const riskCounts = {
    low: 0,
    moderate: 0,
    high: 0
  };
  
  allPredictions.forEach(pred => {
    const risk = pred.result_json?.risk_category?.toLowerCase();
    if (risk?.includes('low')) riskCounts.low++;
    else if (risk?.includes('moderate')) riskCounts.moderate++;
    else if (risk?.includes('high')) riskCounts.high++;
  });
  
  document.getElementById('total-assessments').textContent = total;
  document.getElementById('low-risk-count').textContent = riskCounts.low;
  document.getElementById('moderate-risk-count').textContent = riskCounts.moderate;
  document.getElementById('high-risk-count').textContent = riskCounts.high;
}

function renderHistory() {
  const tbody = document.getElementById('history-body');
  
  if (filteredPredictions.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5">
          <div class="empty-state">
            <span class="empty-state-icon">üìä</span>
            <h3>No assessments found</h3>
            <p>Start by creating your first CHD risk assessment</p>
            <a href="/predict" class="btn-primary" style="margin-top: 1rem;">
              <span class="btn-icon">‚ûï</span>
              Create Assessment
            </a>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = '';
  
  filteredPredictions.forEach(pred => {
    const result = pred.result_json || {};
    const riskCategory = result.risk_category || 'Unknown';
    const probability = result.chd_risk_probability ? 
      (result.chd_risk_probability * 100).toFixed(1) + '%' : 'N/A';
    
    const riskClass = riskCategory.toLowerCase().replace(' ', '-');
    const riskIcon = getRiskIcon(riskClass);
    
    // Generate key factors from input data
    const keyFactors = generateKeyFactors(pred.input_json);
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <div class="date-info">
          <strong>${formatDate(pred.created_at)}</strong>
          <div style="font-size: 0.8rem; color: #999;">${formatTime(pred.created_at)}</div>
        </div>
      </td>
      <td>
        <div class="risk-badge risk-${riskClass}">
          <span>${riskIcon}</span>
          ${riskCategory}
        </div>
      </td>
      <td>
        <span class="probability-text">${probability}</span>
      </td>
      <td>
        <div class="key-factors">
          ${keyFactors.map(factor => 
            `<span class="factor-tag">${factor}</span>`
          ).join('')}
        </div>
      </td>
      <td>
        <div class="action-buttons">
          <a href="/result/${pred.id}" class="btn-small btn-view">
            <span>üëÅÔ∏è</span>
            View
          </a>
        </div>
      </td>
    `;
    
    tbody.appendChild(row);
  });
  
  updateTableInfo();
}

function getRiskIcon(riskClass) {
  if (riskClass.includes('low')) return '‚úÖ';
  if (riskClass.includes('moderate')) return '‚ö†Ô∏è';
  if (riskClass.includes('high')) return 'üö®';
  return 'üìä';
}

function generateKeyFactors(inputData) {
  if (!inputData) return ['No data'];
  
  const factors = [];
  
  // Age factor
  if (inputData.age > 65) factors.push('Age 65+');
  else if (inputData.age > 55) factors.push('Age 55+');
  
  // Gender
  if (inputData.male === 1) factors.push('Male');
  
  // Smoking
  if (inputData.cigsPerDay > 0) factors.push(`${inputData.cigsPerDay} cigs/day`);
  
  // Cholesterol
  if (inputData.totChol > 240) factors.push('High cholesterol');
  else if (inputData.totChol > 200) factors.push('Elevated cholesterol');
  
  // Blood pressure
  if (inputData.sysBP > 140 || inputData.diaBP > 90) factors.push('High BP');
  else if (inputData.sysBP > 130 || inputData.diaBP > 80) factors.push('Elevated BP');
  
  // BMI
  if (inputData.BMI > 30) factors.push('Obese');
  else if (inputData.BMI > 25) factors.push('Overweight');
  
  return factors.length > 0 ? factors.slice(0, 3) : ['Standard profile'];
}

function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });
}

function formatTime(dateString) {
  return new Date(dateString).toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  });
}

function updateTableInfo() {
  document.getElementById('showing-count').textContent = filteredPredictions.length;
  document.getElementById('total-count').textContent = allPredictions.length;
}

function filterHistory() {
  const filterValue = document.getElementById('risk-filter').value;
  
  if (!filterValue) {
    filteredPredictions = [...allPredictions];
  } else {
    filteredPredictions = allPredictions.filter(pred => {
      const riskCategory = pred.result_json?.risk_category || '';
      return riskCategory.toLowerCase().includes(filterValue.toLowerCase());
    });
  }
  
  renderHistory();
}

function showError(message) {
  const tbody = document.getElementById('history-body');
  tbody.innerHTML = `
    <tr>
      <td colspan="5">
        <div class="empty-state">
          <span class="empty-state-icon">‚ùå</span>
          <h3>Error</h3>
          <p>${message}</p>
          <button onclick="loadDashboardData()" class="btn-primary" style="margin-top: 1rem;">
            <span class="btn-icon">üîÑ</span>
            Retry
          </button>
        </div>
      </td>
    </tr>
  `;
}

function exportHistory() {
  if (allPredictions.length === 0) {
    alert('No assessment history to export');
    return;
  }
  
  const csvContent = generateCSV(allPredictions);
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `chd-assessment-history-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
}

function generateCSV(predictions) {
  const headers = [
    'Date',
    'Risk Category',
    'Risk Probability (%)',
    'Age',
    'Gender',
    'Total Cholesterol',
    'Systolic BP',
    'Diastolic BP',
    'BMI',
    'Cigarettes per Day',
    'Heart Rate',
    'Glucose',
    'Recommendation'
  ];
  
  let csv = headers.join(',') + '\n';
  
  predictions.forEach(pred => {
    const result = pred.result_json || {};
    const input = pred.input_json || {};
    
    const row = [
      formatDate(pred.created_at),
      `"${result.risk_category || 'N/A'}"`,
      result.chd_risk_probability ? (result.chd_risk_probability * 100).toFixed(2) : 'N/A',
      input.age || 'N/A',
      input.male === 1 ? 'Male' : input.male === 0 ? 'Female' : 'N/A',
      input.totChol || 'N/A',
      input.sysBP || 'N/A',
      input.diaBP || 'N/A',
      input.BMI || 'N/A',
      input.cigsPerDay || 'N/A',
      input.heartRate || 'N/A',
      input.glucose || 'N/A',
      `"${result.recommendation || 'N/A'}"`
    ];
    
    csv += row.join(',') + '\n';
  });
  
  return csv;
}

function showHealthTips() {
  const modal = document.getElementById('health-tips-modal');
  const content = document.getElementById('health-tips-content');
  
  modal.style.display = 'block';
  
  // Generate personalized tips based on recent assessments
  setTimeout(() => {
    const tips = generateHealthTips();
    content.innerHTML = tips;
  }, 1500);
}

function generateHealthTips() {
  if (allPredictions.length === 0) {
    return `
      <div class="tips-container">
        <div class="tip-item">
          <div class="tip-icon">üèÉ‚Äç‚ôÇÔ∏è</div>
          <div class="tip-content">
            <h4>Start with Regular Exercise</h4>
            <p>Aim for at least 150 minutes of moderate aerobic activity per week to improve cardiovascular health.</p>
          </div>
        </div>
        <div class="tip-item">
          <div class="tip-icon">ü•ó</div>
          <div class="tip-content">
            <h4>Heart-Healthy Diet</h4>
            <p>Focus on fruits, vegetables, whole grains, and lean proteins while limiting saturated fats and sodium.</p>
          </div>
        </div>
        <div class="tip-item">
          <div class="tip-icon">üö≠</div>
          <div class="tip-content">
            <h4>Quit Smoking</h4>
            <p>If you smoke, quitting is one of the best things you can do for your heart health.</p>
          </div>
        </div>
      </div>
    `;
  }
  
  // Get most recent assessment
  const latest = allPredictions[0];
  const input = latest.input_json || {};
  const result = latest.result_json || {};
  
  let tips = '<div class="tips-container">';
  
  // Personalized tips based on latest assessment
  if (input.cigsPerDay > 0) {
    tips += `
      <div class="tip-item priority">
        <div class="tip-icon">üö≠</div>
        <div class="tip-content">
          <h4>Smoking Cessation Priority</h4>
          <p>You smoke ${input.cigsPerDay} cigarettes per day. Quitting smoking can reduce your CHD risk by 50% within one year.</p>
          <a href="https://smokefree.gov" target="_blank" class="tip-link">Get Help Quitting ‚Üí</a>
        </div>
      </div>
    `;
  }
  
  if (input.BMI > 25) {
    const bmiStatus = input.BMI > 30 ? 'obese' : 'overweight';
    tips += `
      <div class="tip-item">
        <div class="tip-icon">‚öñÔ∏è</div>
        <div class="tip-content">
          <h4>Weight Management</h4>
          <p>Your BMI is ${input.BMI} (${bmiStatus}). Losing 5-10% of body weight can significantly improve heart health.</p>
        </div>
      </div>
    `;
  }
  
  if (input.sysBP > 130 || input.diaBP > 80) {
    tips += `
      <div class="tip-item">
        <div class="tip-icon">ü©∫</div>
        <div class="tip-content">
          <h4>Blood Pressure Control</h4>
          <p>Your BP is ${input.sysBP}/${input.diaBP}. Regular monitoring and medication compliance are crucial.</p>
        </div>
      </div>
    `;
  }
  
  if (input.totChol > 200) {
    tips += `
      <div class="tip-item">
        <div class="tip-icon">ü•ë</div>
        <div class="tip-content">
          <h4>Cholesterol Management</h4>
          <p>Your total cholesterol is ${input.totChol} mg/dL. Focus on heart-healthy fats and consider statin therapy.</p>
        </div>
      </div>
    `;
  }
  
  // Always include exercise tip
  tips += `
    <div class="tip-item">
      <div class="tip-icon">üí™</div>
      <div class="tip-content">
        <h4>Regular Exercise</h4>
        <p>Aim for 150 minutes of moderate exercise weekly. Start with 10-minute walks and gradually increase.</p>
      </div>
    </div>
  `;
  
  tips += '</div>';
  
  return tips;
}

function scheduleReminder() {
  // Simple reminder scheduling
  const months = prompt('How many months between assessments?', '6');
  if (months && !isNaN(months)) {
    const reminderDate = new Date();
    reminderDate.setMonth(reminderDate.getMonth() + parseInt(months));
    
    alert(`Reminder set for ${formatDate(reminderDate.toISOString())}. We recommend setting a calendar reminder to reassess your CHD risk.`);
  }
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// Event listeners
document.getElementById('logout-btn').addEventListener('click', async () => {
  const confirmLogout = confirm('Are you sure you want to logout?');
  if (confirmLogout) {
    try {
      await fetch('/logout', { method: 'POST', credentials: 'same-origin' });
      window.location.href = '/login';
    } catch (error) {
      console.error('Logout error:', error);
      window.location.href = '/login';
    }
  }
});

document.getElementById('risk-filter').addEventListener('change', filterHistory);

document.getElementById('refresh-history').addEventListener('click', () => {
  const btn = document.getElementById('refresh-history');
  const originalContent = btn.innerHTML;
  btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span>';
  btn.disabled = true;
  
  loadDashboardData().finally(() => {
    btn.innerHTML = originalContent;
    btn.disabled = false;
  });
});

// Close modal when clicking outside
window.addEventListener('click', (event) => {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });
});

// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => {
  loadDashboardData();
});

// Additional CSS for tips modal
const additionalCSS = `
<style>
.tips-container {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.tip-item {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1.5rem;
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(169, 62, 83, 0.1);
  border-radius: 12px;
  transition: all 0.3s ease;
}

.tip-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(169, 62, 83, 0.1);
}

.tip-item.priority {
  border-left: 4px solid #e53e3e;
  background: rgba(229, 62, 62, 0.05);
}

.tip-icon {
  font-size: 2rem;
  flex-shrink: 0;
}

.tip-content h4 {
  color: #6B052F;
  margin: 0 0 0.5rem 0;
  font-size: 1.1rem;
}

.tip-content p {
  color: #666;
  margin: 0 0 0.5rem 0;
  line-height: 1.4;
}

.tip-link {
  color: #A93E53;
  text-decoration: none;
  font-weight: 600;
  font-size: 0.9rem;
}

.tip-link:hover {
  text-decoration: underline;
}

.date-info strong {
  color: #6B052F;
}
</style>
`;

document.head.insertAdjacentHTML('beforeend', additionalCSS);
</script>
{% endblock %}